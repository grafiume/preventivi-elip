<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Preventivi ELIP</title>
  <meta name="theme-color" content="#e07b39">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.4/dist/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script defer src="app.js"></script>
</head>
<body>
<header class="header-bar shadow-sm">
  <div class="container d-flex align-items-center justify-content-between py-2">
    <div class="d-flex align-items-center gap-3">
      <img src="logo-elip.jpg" alt="ELIP Tagliente" class="brand-logo">
      <div>
        <strong class="brand-title">Preventivi ELIP</strong><br>
        <small class="text-muted">Scheda lavorazioni</small>
      </div>
    </div>
    <div class="d-flex align-items-center gap-3">
      <span id="progressBadge" class="badge bg-secondary-subtle text-secondary-emphasis">Avanzamento: 0%</span>
      <small class="text-muted" id="sheetId"></small>
    </div>
  </div>
</header>

<main class="container my-3" id="app">
  <ul class="nav nav-tabs" id="tabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="tab-new" data-bs-toggle="tab" data-bs-target="#pane-new" type="button" role="tab">Nuovo preventivo</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="tab-arch" data-bs-toggle="tab" data-bs-target="#pane-arch" type="button" role="tab">Archivio</button>
    </li>
  </ul>

  <div class="tab-content border border-top-0 rounded-bottom p-3 bg-white">
    <div class="tab-pane fade show active" id="pane-new" role="tabpanel">
      <form id="jobForm" autocomplete="off">
        <div class="row g-2">
          <div class="col-md-3">
            <label class="form-label">Cliente</label>
            <input type="text" class="form-control" id="cliente" required>
          </div>
          <div class="col-md-3">
            <label class="form-label">Articolo da riparare</label>
            <input type="text" class="form-control" id="articolo" required>
          </div>
          <div class="col-md-2">
            <label class="form-label">DDT</label>
            <input type="text" class="form-control" id="ddt">
          </div>
          <div class="col-md-2">
            <label class="form-label">Telefono</label>
            <input type="tel" class="form-control" id="telefono">
          </div>
          <div class="col-md-2">
            <label class="form-label">Email</label>
            <input type="email" class="form-control" id="email">
          </div>
        </div>

        <div class="d-flex align-items-center gap-2 mt-3 flex-wrap">
          <button type="button" class="btn btn-outline-secondary" id="btnNuova">Nuova scheda</button>
          <button type="button" class="btn btn-outline-primary" id="btnSalvaBozza">Salva bozza (JSON)</button>
          <div class="btn-group" role="group">
            <button type="button" class="btn btn-primary" id="btnPDFDett">PDF Dettaglio</button>
            <button type="button" class="btn btn-outline-primary" id="btnPDFTot">PDF Totale</button>
          </div>
          <a id="btnScarica" class="btn btn-success d-none" download="preventivo-elip.pdf">Scarica PDF</a>
          <button type="button" class="btn btn-outline-dark" id="btnMail">Prepara Email</button>
          <button type="button" class="btn btn-warning" id="btnArchivia">Archivia preventivo</button>
        </div>

        <hr class="my-3">

        <div class="table-responsive">
          <table class="table align-middle" id="workTable">
            <thead class="table-light">
              <tr>
                <th style="width:80px">Cod</th>
                <th>Descrizione lavori</th>
                <th class="text-center" style="width:70px">Flag</th>
                <th style="width:170px">Importo (‚Ç¨)</th>
                <th style="width:170px">Avanzamento</th>
              </tr>
            </thead>
            <tbody id="workBody"></tbody>
          </table>
        </div>

        <div class="card my-3">
          <div class="card-header bg-light">NOTE</div>
          <div class="card-body">
            <textarea id="note" class="form-control" rows="4" placeholder="Annotazioni tecniche, elenco ricambi, ecc. (uno per riga)‚Ä¶"></textarea>
          </div>
        </div>

        <div class="row justify-content-end mt-2">
          <div class="col-md-5">
            <div class="card">
              <div class="card-body">
                <div class="d-flex justify-content-between small mb-1">
                  <span>Subtotale</span><strong id="subtot">‚Ç¨ 0,00</strong>
                </div>
                <div class="d-flex justify-content-between small mb-1">
                  <span>IVA (22%)</span><strong id="iva">‚Ç¨ 0,00</strong>
                </div>
                <hr class="my-2">
                <div class="d-flex justify-content-between h5">
                  <span>Totale</span><strong id="totale">‚Ç¨ 0,00</strong>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="card my-3">
          <div class="card-header bg-light">Stato preventivo</div>
          <div class="card-body">
            <div class="row g-2 align-items-end">
              <div class="col-md-3">
                <label class="form-label">Stato</label>
                <select id="stato" class="form-select">
                  <option value="DA_INVIARE">Da inviare</option>
                  <option value="INVIATO">Inviato</option>
                  <option value="CONFERMATO">Confermato</option>
                  <option value="CHIUSO">Chiuso (bloccato)</option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label">Inviato il</label>
                <input type="date" class="form-control" id="inviatoData">
              </div>
              <div class="col-md-3">
                <label class="form-label">Operatore invio</label>
                <input type="text" class="form-control" id="operatoreInvio" placeholder="Nome">
              </div>
              <div class="col-md-3">
                <label class="form-label">Operatore lavorazioni</label>
                <input type="text" class="form-control" id="operatoreLavorazioni" placeholder="Nome">
              </div>
              <div class="col-md-3">
                <label class="form-label mt-2">Data presunta consegna</label>
                <input type="date" class="form-control" id="consegnaData">
              </div>
            </div>
          </div>
        </div>

        <p class="text-muted small mt-2">
          Premi **üìç Avanzamento** (dopo o anche prima del flag) per impostare Reparto/Operatore/Date.
        </p>
      </form>
    </div>

    <div class="tab-pane fade" id="pane-arch" role="tabpanel">
      <div class="d-flex gap-2 flex-wrap align-items-center mb-2">
        <select id="filterStato" class="form-select" style="max-width:220px">
          <option value="">Tutti gli stati</option>
          <option value="DA_INVIARE">Da inviare</option>
          <option value="INVIATO">Inviato</option>
          <option value="CONFERMATO">Confermato</option>
          <option value="CHIUSO">Chiuso</option>
        </select>
        <input id="filterQuery" class="form-control" placeholder="Cerca per cliente/articolo/DDT‚Ä¶" style="max-width:320px">
        <button class="btn btn-outline-secondary" id="btnReloadArch" type="button">Aggiorna</button>
      </div>
      <div class="table-responsive">
        <table class="table table-hover align-middle" id="archTable">
          <thead class="table-light">
            <tr>
              <th>N¬∞</th><th>Data</th><th>Cliente</th><th>Articolo</th><th>DDT</th>
              <th>Stato</th><th>Consegna</th><th>Avanzamento</th><th>Totale</th><th></th>
            </tr>
          </thead>
          <tbody id="archBody"></tbody>
        </table>
      </div>
    </div>
  </div>
</main>

<!-- Modal Avanzamento -->
<div class="modal fade" id="progressModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Avanzamento lavorazione <span id="pmCode"></span></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Chiudi"></button>
      </div>
      <div class="modal-body">
        <div class="row g-2">
          <div class="col-md-6">
            <label class="form-label">Stato</label>
            <select id="pmStato" class="form-select">
              <option value="DA_ESEGUIRE">Da eseguire</option>
              <option value="IN_LAVORAZIONE">In lavorazione</option>
              <option value="COMPLETATA">Completata</option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">Reparto</label>
            <select id="pmReparto" class="form-select">
              <option value="">‚Äî</option>
              <option>Avvolgimento</option>
              <option>Tornitura</option>
              <option>Fresatura</option>
              <option>Montaggio</option>
              <option>Collaudo</option>
              <option>Verniciatura</option>
              <option>Altro</option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">Operatore</label>
            <input id="pmOperatore" class="form-control" placeholder="Nome">
          </div>
          <div class="col-md-6">
            <label class="form-label">Presa in carico</label>
            <input id="pmPresa" type="date" class="form-control">
          </div>
          <div class="col-md-6">
            <label class="form-label">Concluso</label>
            <input id="pmConcluso" type="date" class="form-control">
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" id="pmSave">Salva</button>
      </div>
    </div>
  </div>
</div>

<footer class="footer-bar">
  <div class="container py-2 text-center small text-muted">¬© ELIP Tagliente ‚Äî preventivi</div>
</footer>

</body>
</html>
